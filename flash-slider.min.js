(function(b){var a=function(d){this.queue=[];this.elem=false;this.current=0;this.params=d;this.prevControl=false;this.nextControl=false;this.countersAll=0;this.countersCurrent=0;this.carousel=false;this.isInit=false;this.classMap={controlDisabled:"pano-control-disabled",controlPrev:"pano-control-prev",controlNext:"pano-control-next",uiContent:"ui-dialog-content",flashContent:"pano-flash-content",uiTitle:"ui-dialog-title",counters:"pano-counters",countersCurrent:"pano-counters-current",countersAll:"pano-counters-all",carouselWrapper:"jcarousel-wrapper",carousel:"jcarousel",carouselPrev:"jcarousel-control-prev",carouselNext:"jcarousel-control-next",carouselActive:"jcarousel-item-active"}};a.prototype.init=function(){var h=b("<div id="+this.params.flashBlId+"></div>");var d=b(this.params.dialog).dialog("widget").find("."+this.classMap.uiContent);var g=b('<div class="'+this.classMap.flashContent+'"></div>');d.append(g);g.append(h);this.prevControl=b('<div class="'+this.classMap.controlPrev+'"></div>');this.nextControl=b('<div class="'+this.classMap.controlNext+'"></div>');g.append(this.prevControl).append(this.nextControl);var f=b('<div class="'+this.classMap.counters+'"></div>');g.append(f);this.countersAll=b('<div class="'+this.classMap.countersAll+'"></div>');this.countersCurrent=b('<div class="'+this.classMap.countersCurrent+'"></div>');f.append(this.countersCurrent).append("<span>"+this.params.fromText+"</span>").append(this.countersAll);if(this.params.useCarousel){var e=b("<div></div>");e.addClass(this.classMap.carouselWrapper);if(this.params.carouselWrapperClass){e.addClass(this.params.carouselWrapperClass)}d.append(e);this.carousel=b("<div></div>");this.carousel.addClass(this.classMap.carousel);e.append(this.carousel);this.carousel.append("<ul></ul>");e.append('<a href="#" class="'+this.classMap.carouselPrev+'"></a>').append('<a href="#" class="'+this.classMap.carouselNext+'"></a>')}this.isInit=true};a.prototype.fillCarousel=function(){if(!this.carousel){return false}var i=this.carousel.find("ul");i.empty();var h=this;for(var g in this.queue){var e=this.queue[g];var f=b(e).find("img");if(f){var j=f.attr("src");var e=b('<a href=""></a>').append('<img src="'+j+'" alt="" />');(function(k){e.on("click",function(l){l.preventDefault();h.moveTo(parseInt(k))})})(g);var d=b("<li></li>").append(e);i.append(d)}}};a.prototype.initCarousel=function(){if(this.carousel.data("jcarousel")){this.carousel.jcarousel("reload");return}this.carousel.jcarousel();this.carousel.parent().find("."+this.classMap.carouselPrev).jcarouselControl({target:"-=1"});this.carousel.parent().find("."+this.classMap.carouselNext).jcarouselControl({target:"+=1"})};a.prototype.start=function(e){if(!this.isInit){this.init()}var d=this;this.elem=e;this.initQueue(e);b(this.params.dialog).dialog("open");this.prevControl.off("click");this.nextControl.off("click");if(this.queue.length>1){this.prevControl.on("click",function(){d.prev()});this.nextControl.on("click",function(){d.next()})}if(this.params.useCarousel){this.fillCarousel();this.initCarousel()}this.moveTo(this.current);this.checkControlsVisible();this.updateCounters()};a.prototype.initQueue=function(g){this.queue=[];this.current=0;var d=b(g).attr("rel");if(!d){this.queue.push(g);return}var f=0;var e=this;b("a[rel='"+d+"']").each(function(i,h){e.queue.push(h);if(h==e.elem){e.current=f}f++});return};a.prototype.updateCounters=function(){this.countersAll.html(this.queue.length);this.countersCurrent.html(this.current+1)};a.prototype.checkControlsVisible=function(){var d=this.queue.length-1;if(this.current==d){this.nextControl.addClass(this.classMap.controlDisabled)}else{this.nextControl.removeClass(this.classMap.controlDisabled)}if(this.current==0){this.prevControl.addClass(this.classMap.controlDisabled)}else{this.prevControl.removeClass(this.classMap.controlDisabled)}};a.prototype.prev=function(){var d=this.current-1;this.moveTo(d)};a.prototype.next=function(){var d=this.current+1;this.moveTo(d)};a.prototype.moveTo=function(d){if(this.queue[d]){this.insertPano(b(this.queue[d]));this.current=d;if(this.carousel){this.carousel.find("li").removeClass(this.classMap.carouselActive);this.carousel.find("li:eq("+d+")").addClass(this.classMap.carouselActive);this.carousel.jcarousel("scroll",d)}this.checkControlsVisible();this.updateCounters()}};a.prototype.insertPano=function c(f){var d=b(f).attr("href");var g=b(f).attr("title");if(d){var e={wmode:"opaque"};swfobject.embedSWF(d,this.params.flashBlId,this.params.width,this.params.height,this.params.version,null,null,e)}if(g&&this.params.setTitle){b(this.params.dialog).dialog("widget").find("."+this.classMap.uiTitle).html(g)}};b.fn.flashSlider=function(e){var e=b.extend({width:800,height:600,version:"9.0.0",flashBlId:"pano-bl",setTitle:true,fromText:"из",useCarousel:true},e);if(!e.dialog){throw new Error("Не задан селектор компонента диалога (params.dialog)")}if(!arguments.callee.instance){arguments.callee.instance=new a(e)}var d=arguments.callee.instance;return this.each(function(){if(this.flashSlider){return}this.flashSlider=d;b(this).on("click",function(f){f.preventDefault();d.start(this)})})}})(jQuery);